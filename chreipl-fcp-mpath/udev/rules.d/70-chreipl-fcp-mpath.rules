# SPDX-License-Identifier: MIT
#
# chreipl-fcp-mpath: use multipath information to change FCP IPL target
# (C) Copyright IBM Corp. 2021

# Did the event affect a multipath or scsi disk device?
ACTION=="change", KERNEL=="dm-[0-9]*", SUBSYSTEM=="block",		\
	ENV{DM_UUID}=="mpath-*", ENV{DM_ACTION}=="PATH_FAILED",		\
	GOTO="chreipl_fcp_mpath_path_change"
ACTION=="change", KERNEL=="dm-[0-9]*", SUBSYSTEM=="block",		\
	ENV{DM_UUID}=="mpath-*", ENV{DM_ACTION}=="PATH_REINSTATED",	\
	GOTO="chreipl_fcp_mpath_path_change"
ACTION=="add", KERNEL=="sd[a-z]*", SUBSYSTEM=="block",			\
	GOTO="chreipl_fcp_mpath_path_change"
GOTO="chreipl_fcp_mpath_end"
LABEL="chreipl_fcp_mpath_path_change"

# Is this system IPL'ed (IOW, are we on s390x)? And do we ReIPL via zFCP?
#
#    udev(7): If no absolute path is given, the program is expected to live
#             in /usr/lib/udev; otherwise, the absolute path must be
#             specified.
TEST!="/sys/firmware/ipl", GOTO="chreipl_fcp_mpath_end"
PROGRAM!="chreipl-fcp-mpath-is-reipl-zfcp", GOTO="chreipl_fcp_mpath_end"

# Consider the following scenarios.
# Either:
#
# (A) We recognized a new SCSI Disk. This might represent:
#     (a) the path we want to ReIPL from.
#
# Or:
#
# (B) We recognized a PATH_ event for a multipath device. This might represent:
#     the path we want to ReIPL from:
#         (a) went away;
#         (b) came back online;
#     an alternative path to the volume we want to ReIPL from:
#         (c) went away;
#         (d) came back online.

# Test whether the affected device is, or contains, the current IPL target.
#
# This covers scenarios:
#     (A) (a),
#     (B) (a)/(b)/(c)/(d)
PROGRAM!="chreipl-fcp-mpath-is-ipl-tgt",				\
	ENV{CHREIPL_FCP_MPATH_IS_TGT}="false",				\
	GOTO="chreipl_fcp_mpath_not_direct_match"
ENV{CHREIPL_FCP_MPATH_IS_TGT}="true"

# If the even subject is not a direct match (not the sdev that is the current
# ReIPL target, and not a mpath device that contains the current ReIPL target)
LABEL="chreipl_fcp_mpath_not_direct_match"

LABEL="chreipl_fcp_mpath_end"
